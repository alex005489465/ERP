## 目標
- 增加地與人的資源管理

## 步驟
- 定義表
- 定義entity...
- 修改舊有的
- 新增單據服務
- 拆分測試類

## 動作
### 表的增改
#### 新增
```
收到！我會把所有主鍵統一設為 `BIGINT`（通常搭配自動遞增或分布式生成器使用）。以下是更新後的四張表定義（摘要格式），主鍵皆為 `BIGINT`，`status` 為 `TINYINT` 並附註狀態意義。

---

## 📄 1. 人員表 `users`

| 欄位名稱            | 型別        | 說明                  |
| --------------- | --------- | ------------------- |
| `id`            | BIGINT    | 主鍵，自動遞增或分散式生成       |
| `name`          | VARCHAR(200)   | 姓名                  |
| `role`          | VARCHAR(200)   | 角色（倉管、管理員…）         |
| `status`        | TINYINT   | 狀態：0=停用, 1=啟用, 2=停職 |
| `created_at`    | TIMESTAMP | 建立時間                |
| `updated_at`    | TIMESTAMP | 更新時間                |

---

## 📦 2. 倉庫表 `warehouses`

| 欄位名稱         | 型別            | 說明             |
| ------------ | ------------- | -------------- |
| `id`         | BIGINT        | 主鍵             |
| `name`       | VARCHAR(200)       | 倉庫名稱           |
| `type`       | VARCHAR(200)       | 類型（常溫/冷藏/GMP…） |
| `location`   | VARCHAR(200)       | 地點/地址          |
| `area_m2`    | DECIMAL(10,2) | 總面積（單位：平方公尺）   |
| `status`     | TINYINT       | 狀態：0=停用, 1=啟用  |
| `created_at` | TIMESTAMP     | 建立時間           |
| `updated_at` | TIMESTAMP     | 更新時間           |

---

## 🧊 3. 儲位表 `storage_locations`

| 欄位名稱           | 型別            | 說明                       |
| -------------- | ------------- | ------------------------ |
| `id`           | BIGINT        | 主鍵                       |
| `warehouse_id` | BIGINT        | 所屬倉庫（→ warehouses.id） |
| `code`         | VARCHAR(200)       | 儲位編號（如 A01-B02）          |
| `zone`         | VARCHAR(200)       | 區域/分區                    |
| `capacity`     | INTEGER       | 可容納容量（數量或件數）             |
| `unit`         | VARCHAR(200)   | 單位（箱、件、kg）               |
| `size_limit`   | VARCHAR(200)   | 尺寸限制（[長,寬,高]，單位 mm） |
| `weight_limit` | DECIMAL(10,2) | 承重限制（單位：kg）              |
| `status`       | TINYINT       | 狀態：0=停用, 1=啟用, 2=維護中     |
| `created_at`   | TIMESTAMP     | 建立時間                     |
| `updated_at`   | TIMESTAMP     | 更新時間                     |

---

## 📑 4. 單據表 `slips`

| 欄位名稱         | 型別        | 說明                                        |
| ------------ | --------- | ----------------------------------------- |
| `id`         | BIGINT    | 主鍵                                        |
| `slips_type` | TINYINT   | 單據類型：<br>1=入庫單<br>2=出庫單<br>3=轉倉單<br>4=報廢單 |
| `created_by` | BIGINT    | 建立人（→ `users.id`）                     |
| `status`     | TINYINT   | 狀態：0=草稿，1=完成，2=取消                         |
| `created_at` | TIMESTAMP | 建立時間                                      |
| `updated_at` | TIMESTAMP | 更新時間                                      |


```
#### 修改
- 之前的表需要修改 : stocks、stock_movements
  - stocks : 位置 -> 倉庫ID、儲位ID
  - stock_movements : 
    - 位置 -> 倉庫ID、儲位ID
    - quantity_change與note中間要插入 -> 單據ID

### 新增單據服務
- 人 -> 動作 -> 單據 -> 其他...
- 將出入庫實際的操作，綁定到單據上，由單據調用
- 先新增一個單據服務，只有基本的CRUD
- 根據狀態管理
  - 創建 -> status = 草稿
  - 成功 -> 改為成功，並調用庫存服務，先用事務，異步處理等等
  - 取消 -> 只改變狀態
- 創建兩個表
  - 紀錄單據與庫存異動間的關聯
  - 紀錄單據內的資料
- 修改創建新單據的方法->增加:解析單據資料到單據資料表
- 修改異步處理，逐一處理SlipDetail到StockMovement，並更新SlipDetail.status


## 思考
- 地，倉庫 -> 倉庫、儲位、倉庫規劃的歷史、環境管理(GMP/食品有要求)
  - 環境管理
    - 測量(溫溼度)、評分(髒亂、垃圾、外觀)
    - 不同倉庫/儲位，可根據分類/分區，對應到不同的管理要求/測量欄位
    - 分類/分區，又可對應到不同的管理文件ID
  - 先假設倉庫規畫是靜止的畫面，不管歷史變動
    - 位置可以再對應到廠區規劃圖的編號(圖ID、圖上的標號)或者3D圖?
  - 容量的單位，也可以獨立一張表維護，另一張表維護單位間的換算關係(自訂 & 國際SI)，這樣不同的自訂單位可藉由SI來實現自動換算
  - 先兩張表 -> 倉庫、儲位
- 地、物，通常是結合在一起的
- 人，操作者/員工/權限/身分
  - 先一張表 -> 員工
- 操作，需要一張單據，將人與庫存操作關聯在一起
  - 有些地方，調動東西需要提前寫單子審批，過了才能動作
  - 申請 -> 調動
  - 多個操作可能源於同一張單據，比如轉庫，兩筆操作源於一張單
  - 之後可以再擴充，單據 = 人 with 多種操作
- 先新增四張表 : 人、單據、倉庫、儲位
- 之前的表需要修改 : stocks、stock_movements
- 接著來拆服務
  - 商品管理拆出來，跟金錢、生產等相關
  - 建立單據的服務
    - 人 -> 動作 -> 單據 -> 其他...
    - 人的操作只面對單據，對單據的增改刪(之後做軟刪除)，都能異步推送到排程-操作紀錄(查，某些狀況下也是可以記錄，但體感不好...除非是敏感資訊...)
  - 將出入庫實際的操作，綁定到單據上，由單據調用?
    - 或者庫存異動由單據觸發建立
    - 似乎可以，人的操作，皆由單據管理
    - 將庫存異動作為人的操作與實際庫存的中介
    - 用排程sleep60固定時間處理，結束後loop直到空，sleep
    - 當操作發生便觸發
  - 那這邊庫存服務不用動，改操作的控制器就好，改為調單據服務，再由單據去調庫存
- 異步處理，逐一處理SlipDetail到StockMovement，現在先這樣，之後再來思考
  - 處理
    - 加一個容器 + java cli + crontab ?
    - 加一個容器 + crontab + python/js
  - 訊息傳遞
    - redis
    - rabbitmq?
  - 處理需要鎖避免多次處理同一slip?
  - 處理失敗(ex:庫存不夠)，用websocket通知前端?
### 之後
- 需要新增一些表?再等等
  - 單據與異動間的關聯，應該用額外的表來管理會更好，新增一張表
  - 單據明細表
  - 單據狀態機
- 似乎先建方法名，內容空著，這樣用AI更好控制
## 其他